<html>
<head>
  <script src="spark-md5.js"></script>
  <script src="jquery-1.8.2.js"></script>
  <script src="echonest-analysis.js"></script>
  <script src="audiojedit.js"></script>
  <script src="drag-drop-file.js"></script>
  <script src="FileSaver.js"></script>
  <link href="drag-drop-file.css" rel="stylesheet"/>
  <style>
  html {
    background: #ABC;
    padding: 1em ;
    font-family: Helvetica, sans-serif;
  }
  body {
    background: #EEF;
    padding: 1em;
  }
  #debug {
    background-color: rgba(255, 127, 0, 0.5);
    padding: 1em;
    box-shadow: 1px 1px 8px rgba(0, 0, 0, 0.2);
  }
  #output_bpm, #output_text, #beat_pattern, #overlap {
    font-size: 120%;
    padding: 0.5em;
    margin: 0.5em;
    width: 80%;
    background: rgba(0, 0, 0, 0.1);
    border-radius: 8px;
  }
  #output_bpm {
    width: 80%;
  }
  #output_text {
    font-size: 80%;
    height: 40%;
  }
  #beat_pattern {
    text-align: center;
    width: 20%;
  }
  #overlap {
    text-align: center;
    width: 20%;
  }
  .hidden {
    display: none;
  }
  #rehack_button, #download_button {
    font-size: 150%;
  }
  </style>
  <script>
    function displayString(str) {
      console.log(str);
      $("#output_bpm").stop().fadeOut(0).html(str).fadeIn(100);
    }

    function hack(pattern, b, c) {
      //console.log("Hack-b-c");
      var i = 0;
      while (i < pattern.length) {
        if (isNumber(pattern[i])) {
          p = parseFloat(pattern[i]);
          c(p);
        }
        else if (pattern[i] === "[") {
          p3 = pattern[i+3];
          if (p3 !== "]") {
            console.log("WARNING: Pattern is irregular. No closing ] at position " + i+3);
          }
          p1 = parseFloat(pattern[i+1]);
          p2 = parseFloat(pattern[i+2]);
          b(p1, p2);
          i += 3;
        }
        else {
          console.log("WARNING: Pattern is irregular. No closing ] at position " + i);
        }  
        i += 1;
      }
    }

    // From http://stackoverflow.com/questions/18082/validate-numbers-in-javascript-isnumeric
    function isNumber(n) {
      return !isNaN(parseFloat(n)) && isFinite(n);
    }

    function beatsPerBar(pattern) {
      max_beat_index = 0;
      function update_max_beat_index(i) {
        if (i > max_beat_index) {
          max_beat_index = i;
        }
      }
      function update_max_beat_index_b(j, k) {
        update_max_beat_index(j);
        update_max_beat_index(k);
      }
      function update_max_beat_index_c(j) {
        update_max_beat_index(j);
      }

      hack(pattern, update_max_beat_index_b, update_max_beat_index_c);

      return max_beat_index;
    }


    function hackData(audioData, audio_analysis) {
      try {
      console.log("Datafying-hack data.");

      pattern = document.getElementById("beat_pattern").value;
      beats_per_bar = beatsPerBar(pattern);

      hack_data = [];

      var beat_type = (document.getElementById("beat_type_tatums").checked ? "tatums" : "beats");
      beats = audio_analysis[beat_type];
      function idx(i, j) {
        return beats[i*beats_per_bar+j]["start"];
      }

      num_samples = 0;
      function samplesBetweenTimes(t1, t2) {
        // We must compute these separately, then subtract.
        // Else, we mgith risk rounding error.
        var sampleStart = Math.floor(t1 * audioData.sampleRate);
        var sampleEnd = Math.floor(t2 * audioData.sampleRate);
        return sampleEnd - sampleStart;
      }
      
      function copy_beat(i, j) {
        //console.log("copy_beat");
        hack_data.push({
          "kind": "copy",
          "segment": {
            "start": idx(i, j-1),
            "end": idx(i, j)
          }
        });
        // Mimic hacking computation.
        num_samples += samplesBetweenTimes(idx(i, j-1), idx(i, j));
      }

      function blend_beats(i, j, k) {
        //console.log("blend_beats");
        hack_data.push({
          "kind": "blend",
          "segment1": {
            "start": idx(i, j-1),
            "end": idx(i, j)
          },
          "segment2": {
            "start": idx(i, k-1),
            "end": idx(i, k)
          }
        });
        num_samples += Math.max(
          samplesBetweenTimes(idx(i, j-1), idx(i, j)),
          samplesBetweenTimes(idx(i, k-1), idx(i, k))
        )
      }

      // Everything up to the first beat
      hack_data.push({
        "kind": "copy",
        "segment": {
          "start": 0,
          "end": idx(0, 0)
        }
      });
      num_samples += samplesBetweenTimes(0, idx(0, 0));

      console.log("Go bars!");
      num_bars = Math.floor((beats.length-1)/beats_per_bar);
      console.log(num_bars);
      for (var i = 0; i < num_bars; i++) {
        //console.log("Bar #" + i);
        function b(j, k) {return blend_beats(i, j, k)};
        function c(j) {return copy_beat(i, j)};
        hack(pattern, b, c);
      }
      console.log("Done bars!");

      // Add everything from the final bar onwards.
      hack_data.push({
        "kind": "copy",
        "segment": {
          "start": idx(num_bars, 0),
          "end": audioData.duration
        }
      })
      num_samples += samplesBetweenTimes(idx(num_bars, 0), audioData.duration);

    } catch (e) {
      console.log(e);
    }


      overlap = document.getElementById("overlap").value / 100;
      return {
        "overlap": overlap,
        "num_samples": num_samples,
        "segments": hack_data
      };
    }

var aa;

    function callback(audio_analysis) {

      aa = audio_analysis;
      $("#output_text").attr("value", JSON.stringify(audio_analysis, null, 2)).fadeOut(0).fadeIn(400);
      displayString("BPM of \"" + audio_analysis.meta.title + "\" is: " + audio_analysis.track.tempo + "<br>(confidence: " + Math.round(100*audio_analysis.track.tempo_confidence ) + "%)");
      displayString("Please wait a moment for waltzification.");

      var reader = new FileReader();

      reader.onload = function (fileEvent) {
        console.log("xFileOnload");
        d = fileEvent.target.result;
        goData(d);
      };

      reader.readAsArrayBuffer(xFile);
      console.log("go-go buffer");

    }


var context = new webkitAudioContext();
var context2 = new webkitAudioContext();
var analyser = context.createAnalyser();
var xFile;
var ev;
var w;
var d;
var src;
var buf;
var blob;
var blob2
var hack_data;
    
    function saveFile() {
      var fileName = aa.meta.title;
      if (fileName === "") {
        fileName = "Song";
      }
      var extension = ".wav";
      saveAs(blob, fileName + extension);
    }

    function goData(data) {
        console.log("goData()");
        context.decodeAudioData(data, function(buffer) {

          buf = buffer;

          console.log("decoding1.0");
          hack_data = hackData(buffer, aa);

          console.log("decoding1.1");
          w = Wav.createWaveFileData(buffer, hack_data);

          //source = context2.createBufferSource();
          //src = source;
          //buffer = context2.createBuffer(w.buffer, false);
          //source.buffer = buffer;
          //source.connect(context2.destination);
          //source.noteOn(0);
          
          console.log("Done");
          displayString("Hacked version of \"" + aa.meta.title + "\" is playing.");
          document.getElementById("download_button_div").classList.remove("hidden");
          document.getElementById("download_button").addEventListener("click", saveFile);
          blob = new Blob([w]);

          url = webkitURL.createObjectURL(blob);
          document.getElementById("output_audio").src = url;
          document.getElementById("output_audio").play();

        }, function(e) {
            displayString("Failed to decode audio file (unknown reason). :-(");
            console.log(e);
        });

    }

    var echonest; // For easier console debugging.
    function go(file) {
      xFile = file;
      try {
        echonest = echonestAnalysis(file);
        echonest.setProgressCallback(displayString);
        echonest.go(callback);
      }
      catch (e) {
        console.log(e);
      }
    }

    function rehack() {
      xFile && go(xFile);
    }

    $(document).ready(function() {
      document.getElementById("rehack_button").addEventListener("click", rehack);
    });

  </script>
</head>
<body>

<a href="https://github.com/lgarron/echonest-analysis.js/"><img style="position: absolute; top: 0; right: 0; border: 0;" src="https://s3.amazonaws.com/github/ribbons/forkme_right_darkblue_121621.png" alt="Fork me on GitHub"></a>

<center>
<h1>Waltzify! <sup style="font-size: 50%; font-variant: small-caps;">Very Beta</sup></h1>

<div id="new_song">Drag and drop a song here!</div>
<!--input type="file" name="track" id="track" onchange=""><br-->

<div id="output_bpm">No output yet...</div>
<input id="beat_type_tatums" type="checkbox">
<label for="beat_type_tatums">Use tatums (divide beats in half)</label>
<br>
<input type="text" id="beat_pattern" value="12[34]">
<input type="number" id="overlap" min="0" max="100" step="5" value="100"><br>


<div id="download_button_div" class="hidden">
  <button id="rehack_button">Re-hack</button><br>
  <audio id="output_audio" controls="controls"></audio><br>
  <button id="download_button">Download .wav</button><br>
</div>

<textarea id="output_text">[Analysis will appear here.]</textarea>

<br>
Thanks to the <a href="http://the.echonest.com/">Echonest</a> <a href="http://developer.echonest.com/docs/v4/track.html">Track API</a>.<br>
Only tested in Google Chrome.<br>
</center>

</body>
</html>